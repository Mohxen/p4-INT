#--------------------mininet logs
make mn-log

#--------------------BMv2 logs, created on P4 by doing log_msg("") in the code
tmp/switchID/stratum_bmv2.log
 * Example: log_msg("User defined message");
 * or log_msg("Value1 = {}, Value2 = {}",{value1, value2});

#--------------------At first execution
#install docker for ubuntu (ubuntu uses a diferent version) https://docs.docker.com/engine/install/ubuntu/
sudo apt install python3-pip
sudo pip3 install scapy
sudo make deps 

#influxdb, to install see the file "prepare inluxdb.txt"
#grafana, to install see the file "prepare grafana.txt"  url=http://localhost:3000/

#to help dissecting INT reports, install wirehsark plugin located at "util/wireshark/P4INT_report_IPV6.lua"
#into /usr/lib/x86_64-linux-gnu/wireshark/plugins/
#it's limited to a fixed certain number of hops, buts easy to modify it to a different number and new report's fields
#some data is displeyed incorrectly, trust the one printed by the INT collector

#the used stratum image is a custom image of stratrum version: 2022-06-30 built from source by modifying the Dockerfile 
(see file Dockerfile at util/stratum/Dockerfile) adding X11, pip3 at runtime and scapy to it, dropped at /tools/mininet/ to compile it,  
the image was compiled with name:davidcc73/ngsdn-tutorial:stratum_bmv2_X11_scapy
(the official installation script contains some small naming errors that will pop up during compilation)
the image was published at docker hub, and is pulled from there, by doing make deps

#--------------------Start ONOS and mininet. Execute this commands in groups, not all at once
sudo make stop                                      #Delete the mininet and ONOS containers
sudo mn -c                                          #Delete virtual interfaces that mininet created
make clean                                          #Delete P4 and ONOS compilations
xhost +                                             #Enable X11 forwarding
sudo make start                                     #Start ONOS and mininet containers
sudo make app-build                                 #Recompile P4 code and ONOS apps

make app-reload                                     #Push ONOS apps to ONOS
make netcfg                                         #Push mininet topology to ONOS

#--------------------at ONOS cli (make onos-cli) wait a few seconds for the devices to be detected
#source /config/Static_Routing_Tables/static_routing_tables.txt    #Push static routing rules to switchs

INT_Role-set                                        #Push INT roles at config\INT_Tables to switchs, 1 file peer device               
Packet_Priority-set                                 #Push packet priority values to all switchs
source /config/ua_config.txt
source /config/INT_Tables/INT_Transit_config.txt    #Push INT instructions to switchs
source /config/hosts_routing_tables.txt             #Push host routing rules to switchs (between switch and it's hots)
Calculate-Routing-Paths KShort latency              #Creates the routing rule between switchs (KShort, ECMP - latency, bandwidth)

#--------------------at mininet cli (make mn-cli) 
#For the hosts be detected in the topology send a packet from them, or ping 2 in the same switch (both will be detected)
h1_1 ping h1_2
h2_1 ping h2_2

h3_1 ping h1_2


#--------------------Start the INT collector
Note: make sure the collector (THE SYSTEM RUNNING IT) is syncronized with an ntp or rather manually syn it
sudo python3 INT/receive/collector_influxdb.py 



#--------------------To create INT traffic
# At a h2_1 terminal run:
python3 /INT/receive/receive.py 

# At h1_1 terminal run with real ips (xterm h1_1 h2_1):  
h1_1 python3 /INT/send/send.py --ip h2_1 --l4 udp --port 443 --m INTH1 --dscp 18 --c 1000


#The generated telemetry should be visible in the grafana dashboard


#--------------------at ONOS cli (make onos-cli)
#To see the SRv6 commands go to config/srv6_insert.txt



#--------------------at ONOS cli (make onos-cli) so test path calculation
#----------KShort
h1_1 h2_1
path -kshort -geo 00:00:00:00:00:10/None 00:00:00:00:00:20/None

h1_1 h3_1
path -kshort -geo 00:00:00:00:00:10/None 00:00:00:00:00:30/None

r1 r2
path -kshort -geo device:r1 device:r2

r1 r9
path -kshort -geo device:r1 device:r9

r9 r14
path -kshort -geo device:r9 device:r14

r1 h2_1
path -kshort -geo device:r1 00:00:00:00:00:20/None


#----------ECMP
h1_1 h2_1
path -ecmp -geo -flowLabel 2 00:00:00:00:00:10/None 00:00:00:00:00:20/None



#--------python3 scrits to create ba chat like traffic between h1 and h2_1 using tcp, 
#can not be used at mininet, server does not reply to the SYN packet, probably mininet is blocking it on how simulates hosts
python3 /INT/h1_tcp.py
python3 /INT/h2_tcp.py